rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Subscribers collection â€” email waitlist signups
    // Document ID = normalized email address
    match /subscribers/{email} {
      // Anyone can create or overwrite their signup (setDoc is idempotent)
      // Validates: required fields, email format, and doc ID matches email field
      allow create, update: if
        request.resource.data.keys().hasAll(['email', 'subscribedAt']) &&
        request.resource.data.email is string &&
        request.resource.data.email.size() > 0 &&
        request.resource.data.email.size() <= 320 &&
        request.resource.data.email.matches('.*@.*[.].*') &&
        request.resource.data.email == email;

      // Only admins via Firebase console can read or delete
      allow read, delete: if false;
    }

    // Deny all other access by default
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
